from io import StringIO

import numpy as np
import pandas as pd

from pharmpy import Model
from pharmpy.methods.frem.results import FREMResults


def test_frem_results(testdata):
    model = Model(testdata / 'nonmem' / 'model_4.mod')
    np.random.seed(39)
    res = FREMResults(model, continuous=['APGR', 'WGT'], samples=10)

    correct = pd.DataFrame({
        'parameter': ['0', '0', '0', '0', '1', '1', '1', '1'],
        'covariate': ['APGR', 'APGR', 'WGT', 'WGT', 'APGR', 'APGR', 'WGT', 'WGT'],
        'condition': ['5th', '95th', '5th', '95th', '5th', '95th', '5th', '95th'],
        '5th': [1.021471, 0.855472, 0.862255, 0.976016, 0.813598, 1.020936, 0.942373, 0.915405],
        'mean': [1.159994, 0.935780, 0.939846, 1.145692, 0.876731, 1.065829, 1.005247, 0.993865],
        '95th': [1.389830, 0.990048, 1.013764, 1.359351, 0.957428, 1.103065, 1.044549, 1.129945]})
    pd.testing.assert_frame_equal(res.covariate_effects, correct)

    correct = """,parameter,observed,5th,95th
1.0,0,0.974787628525673,0.9404264854788376,0.9818769791865711
1.0,1,1.0220100211774878,1.0050370645296267,1.0271736843358379
2.0,0,0.9322193602958176,0.8349257890286346,0.9712071754974831
2.0,1,1.0863060524919126,1.0223184516672452,1.1073589355085347
3.0,0,1.0091536233934566,1.001937649639671,1.0281476002522005
3.0,1,0.9872706597459394,0.9843221847194776,0.9966413138904178
4.0,0,0.9606207522118253,0.8812332453173569,1.0135660814225842
4.0,1,1.003501058808901,0.9708375413213933,1.0322946795457462
5.0,0,0.974787628525673,0.9404264854788376,0.9818769791865711
5.0,1,1.0220100211774878,1.0050370645296267,1.0271736843358379
6.0,0,1.010960869697585,0.9626229536716822,1.0851986449208786
6.0,1,0.9641361715262539,0.9474230023091901,0.9971230579026553
7.0,0,0.9944872959330749,0.9214086942338469,1.0753020252227097
7.0,1,0.9693908394797994,0.9439756489488248,1.0050640341421608
8.0,0,0.9589034965235579,0.897117705873169,0.9722960672474761
8.0,1,1.0275801091641075,1.0004527054778583,1.0399780556788991
9.0,0,0.9493585953571453,0.8869600512954363,0.9717176873867448
9.0,1,1.055100455328332,1.0138175544843107,1.0681986763796631
10.0,0,0.974787628525673,0.9404264854788376,0.9818769791865711
10.0,1,1.0220100211774878,1.0050370645296267,1.0271736843358379
11.0,0,0.9589034965235579,0.897117705873169,0.9722960672474761
11.0,1,1.0275801091641075,1.0004527054778583,1.0399780556788991
12.0,0,0.9927094986473942,0.9612281672946054,1.0182676514876956
12.0,1,0.9926514136793081,0.9817421103084205,1.0058745019041289
13.0,0,0.9765333303674195,0.9202126851359765,1.0150526947170735
13.0,1,0.998061493423796,0.9765066707622273,1.0188963252813406
14.0,0,0.9510587575256984,0.8762015050595144,0.9714177194747982
14.0,1,1.0303765269775598,0.9971765992494146,1.0465940183970204
15.0,0,0.9668129422805504,0.9185795376065111,0.9733914386293293
15.0,1,1.0247912807632464,1.0035220396641717,1.0334056421812001
16.0,0,0.9095267118698269,0.8009620865353312,0.9430032005880522
16.0,1,1.0951989064762164,1.022695756753159,1.1182431972909042
17.0,0,1.0026902520717458,0.9417523018347664,1.080186585405375
17.0,1,0.9667599353969294,0.9456922816314794,1.0007772522942384
18.0,0,0.9944872959330749,0.9214086942338469,1.0753020252227097
18.0,1,0.9693908394797994,0.9439756489488248,1.0050640341421608
19.0,0,1.1053966073550503,1.0036565365982064,1.4131448975917391
19.0,1,0.8533835882796981,0.8216502825580798,0.9641513405624227
20.0,0,0.9845881945267835,0.9404587655289749,1.0158422704711434
20.0,1,0.9953527778561793,0.9793606694516137,1.0122642770020271
21.0,0,1.0073496078169473,0.97471065625839,1.048079472336644
21.0,1,1.0109602609890682,0.994073674619684,1.0248038547749165
22.0,0,0.957189310690998,0.8948653791375218,0.9812998420197734
22.0,1,1.0522369373511546,1.0136260025681645,1.0647201644480657
23.0,0,1.2458831194124333,1.1777642932294263,1.7539708702591352
23.0,1,0.8590846978787242,0.8104918263532488,0.9860870666555259
24.0,0,1.2898065460488006,1.228680525393907,1.8960459562937053
24.0,1,0.8298833659920394,0.7798180680015087,0.9718318448226384
25.0,0,1.078488373466804,0.9438005946287329,1.3941243356817097
25.0,1,0.8603696633602557,0.8186849381599031,0.9742255295613883
26.0,0,1.0986748496525185,0.9239383435215645,1.4659551166117084
26.0,1,1.0288376555754981,0.9288092677631552,1.1364011219518906
27.0,0,1.0707971800371383,1.0528713865146948,1.1813196259664536
27.0,1,0.9459681291986676,0.9326030974491732,0.9876691804464637
28.0,0,1.0719302408624465,0.9188921758226687,1.3679964930701851
28.0,1,1.0372600546071509,0.9466788506205037,1.1261244021360866
29.0,0,0.9432781959243836,0.8558161796778232,0.9705692942981503
29.0,1,1.0331805548571447,0.9939144549590619,1.053253829092999
30.0,0,0.9810711387023736,0.9101140502171128,1.024164358607576
30.0,1,1.0436929282351648,1.0063446770588311,1.0603054368703553
31.0,0,0.9493585953571453,0.8869600512954363,0.9717176873867448
31.0,1,1.055100455328332,1.0138175544843107,1.0681986763796631
32.0,0,1.1077371892512407,0.9256825575547856,1.5003750343229567
32.0,1,1.0260454142230664,0.9227653586948521,1.1398582687765162
33.0,0,0.9730450473914594,0.9055020139336152,1.0037540338019146
33.0,1,1.046533194867676,1.0099432826428314,1.0590941168415835
34.0,0,1.0815630311103914,1.0433530549377346,1.2000733491030267
34.0,1,0.9212942981483625,0.9040793124231854,0.9791220157078377
35.0,0,1.1248964293826664,1.0738575128589374,1.3632809503243906
35.0,1,0.9306682547212441,0.897960671542905,1.0045044334993052
36.0,0,1.03618429556192,1.0124879718764244,1.1018979610346578
36.0,1,0.9563075276665232,0.9464376432326478,0.9879934192361145
37.0,0,0.9095267118698269,0.8009620865353312,0.9430032005880522
37.0,1,1.0951989064762164,1.022695756753159,1.1182431972909042
38.0,0,0.9415919426929809,0.8678543204558119,0.9622351930854139
38.0,1,1.0579717659755008,1.0138277618077383,1.0716909187423422
39.0,0,0.9382284741437185,0.7975775673106207,1.0044172935629325
39.0,1,1.109353060529306,1.0234236362495515,1.1388955190136536
40.0,0,1.0571247398166508,0.9830437890392674,1.2383626298852648
40.0,1,0.907071102862022,0.8823494618627619,0.9802230325173229
41.0,0,0.9991085337343418,0.9697274171522885,1.0251795347895507
41.0,1,1.0137114501735511,0.9996048148783625,1.0229093494974173
42.0,0,1.0372807308673064,0.8985567369131262,1.2488578313862553
42.0,1,1.0485972706172273,0.9709062999594144,1.1170127163086545
43.0,0,1.0963534159335382,0.9832144230515908,1.4066397178735592
43.0,1,0.8557059542409411,0.8206511251510248,0.9673128720869331
44.0,0,0.974787628525673,0.9404264854788376,0.9818769791865711
44.0,1,1.0220100211774878,1.0050370645296267,1.0271736843358379
45.0,0,1.0590178953627924,0.9438281460246993,1.3079239698598064
45.0,1,0.8858159125690391,0.8489177852545279,0.9807963733784358
46.0,0,0.9262487332879905,0.8294291176332554,0.9435786763404528
46.0,1,1.0637378501642383,1.013854438013312,1.0810181426357148
47.0,0,1.0203782758399829,0.8878882406068267,1.1938037281385465
47.0,1,1.0543122625829007,0.9832584592837018,1.112748097846439
48.0,0,0.8963082917194926,0.754755072640469,0.926606484317251
48.0,1,1.0753644675509202,1.0033675012843282,1.1086312886019938
49.0,0,0.9415919426929809,0.8678543204558119,0.9622351930854139
49.0,1,1.0579717659755008,1.0138277618077383,1.0716909187423422
50.0,0,0.9765333303674195,0.9202126851359765,1.0150526947170735
50.0,1,0.998061493423796,0.9765066707622273,1.0188963252813406
51.0,0,0.887386461639495,0.7489371159684193,0.9156704339562873
51.0,1,1.10416456025005,1.022742064354358,1.1309741113950769
52.0,0,0.9355612866877128,0.8359473895136671,0.9697506785500194
52.0,1,1.0359922135126096,0.9906662068673342,1.0599577886308817
53.0,0,0.9730450473914594,0.9055020139336152,1.0037540338019146
53.0,1,1.046533194867676,1.0099432826428314,1.0590941168415835
54.0,0,0.9810711387023736,0.9101140502171128,1.024164358607576
54.0,1,1.0436929282351648,1.0063446770588311,1.0603054368703553
55.0,0,1.0295477996858795,0.9633365891752962,1.1565617675210336
55.0,1,0.936440067918556,0.9138659254547379,0.9904430570705107
56.0,0,0.988117858694446,0.8643836810597042,1.1314877285997145
56.0,1,0.9492515715913541,0.9060442990602352,1.0106258548725133
57.0,0,1.0601384919733423,1.0243575628671684,1.1734574731500553
57.0,1,0.9713027674849692,0.9511755393845582,1.010753734219014
58.0,0,0.9493585953571453,0.8869600512954363,0.9717176873867448
58.0,1,1.055100455328332,1.0138175544843107,1.0681986763796631
59.0,0,0.9765333303674195,0.9202126851359765,1.0150526947170735
59.0,1,0.998061493423796,0.9765066707622273,1.0188963252813406
"""

    correct = pd.read_csv(StringIO(correct), index_col=0)
    correct['parameter'] = correct['parameter'].astype(str)
    pd.testing.assert_frame_equal(res.individual_effects, correct)

    correct = """parameter,condition,sd_observed,sd_5th,sd_95th
0,none,0.19836380718266122,0.17043119968781134,0.2571122896534397
0,APGR,0.1932828383897819,0.16286797347439572,0.25676665494534223
0,WGT,0.19363776172900196,0.1570315937463376,0.24305552931107305
0,all,0.1851006246151042,0.14545696634659333,0.22339242428129563
1,none,0.16105092362355455,0.12034716530602935,0.18097989530487268
1,APGR,0.1468832868065463,0.11595393414184042,0.16855369364464015
1,WGT,0.16104200315990183,0.11955480219369144,0.1776783523537583
1,all,0.14572521381314374,0.11534269901794805,0.16219608849175327
"""
    correct = pd.read_csv(StringIO(correct))
    correct['parameter'] = correct['parameter'].astype(str)
    pd.testing.assert_frame_equal(res.unexplained_variability, correct)

    correct = pd.DataFrame({'5th': [1.0, 0.7], 'ref': [6.423729, 1.525424], '95th': [9.0, 3.2]},
                           index=['APGR', 'WGT'])
    pd.testing.assert_frame_equal(res.covariate_statistics, correct)
